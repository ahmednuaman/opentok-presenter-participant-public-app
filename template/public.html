<!DOCTYPE html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="description" content="" />
		<meta name="author" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css" />
		<link type="text/css" rel="stylesheet" href="/assets/css/styles.css" />
		<link type="text/plain" rel="author" href="/assets/humans.txt" />
		<title>Some title</title>
	</head>
	<body>
		<div id="container" class="container">
			<h1>
				Welcome!
			</h1>
			<h4>
				You're now watching the live feed:
			</h4>
			<div class="row">
				<div class="span8" id="presenter-webcam"></div>
			</div>
			<div class="row">
				<div class="span8" id="participant-webcam"></div>
			</div>
		</div>
		<div id="no-js" class="alert-message block-message error container-fluid">
			<h1>
				Oh dear...
			</h1>
			<h3>
				Sorry but this web site requires that <a href="http://www.google.co.uk/search?q=define%3A+javascript">JavaScript</a> be enabled. Please <a href="http://www.google.co.uk/search?q=how+to+enable+javascript">enable it for your browser</a>.
			</h3>
		</div>
		<!--<script src="https://www.tokbox.com/v0.91/js/TB.min.js"></script>-->
		<script src="https://staging.tokbox.com/v0.91/js/TB.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
		<script>
		<!--
			var apiKey		= '{{ config.api_key }}';
			var sessionId	= '{{ session_id }}';
			var token		= '{{ token }}';
			var props		= {{ config.props }};
			var streams		= [ ];
			var presenter;
			var participant;
			
			$( 'html' ).removeClass( 'no-js' );
			
			token			= 'devtoken';
			
			TB.setLogLevel( TB.DEBUG );
			
			var session = TB.initSession( sessionId );    
			  
			session.addEventListener( 'sessionConnected', sessionConnectedHandler );
			session.addEventListener( 'streamCreated', streamCreatedHandler );  
			session.addEventListener( 'streamDestroyed', streamDestroyedHandler ); 
			   
			session.connect( apiKey, token );
			
			function sessionConnectedHandler(e)
			{
				streams	= e.streams;
				
				setInterval( pollForUpdate, 500 );
			}
			
			function streamCreatedHandler(e)
			{
				var s	= e.streams[ 0 ];
				
				streams.push( s );
			}
			
			function streamDestroyedHandler(e)
			{
				var d	= e.streams[ 0 ].streamId;
				
				if ( d == presenter.stream.streamId )
				{
					presenter	= null;
				}
				
				streams.filter( function(s)
				{
					return s.streamId != d;
				});
				
				session.unsubscribe( e.streams[ 0 ] );
			}
			
			function pollForUpdate()
			{
				$.post( '/api/public', { method: 'get_streams' }, function(d)
				{
					if ( !presenter && d.presenter )
					{
						presenter	= addStream( getStream( d.presenter ), 'presenter-webcam' );
					}
					else if ( presenter && d.presenter )
					{
						if ( presenter.stream.streamId != d.presenter )
						{
							session.unsubscribe( presenter );
							
							presenter	= addStream( getStream( d.presenter ), 'presenter-webcam' );
						}
					}
					
					if ( participant )
					{
						if ( participant.stream.streamId != d.participant )
						{
							if ( participant )
							{
								session.unsubscribe( participant );
							}
							
							var s	= getStream( d.participant );
							
							if ( s )
							{
								participant	= addStream( getStream( d.participant ), 'participant-webcam' );
							}
						}
					}
					else if ( d.participant )
					{
						participant	= addStream( getStream( d.participant ), 'participant-webcam' );
					}
					
				}, 'json' );
			}
			
			function addStream(s, t)
			{
				var d	= 'stream' + s.streamId
				
				$( '#' + t ).empty().append( '<div id="' + d + '"></div>' );
				
				return session.subscribe( s, d, props );
			}
			
			function getStream(id)
			{
				var l;
				var s;
				var t;
				
				l	= streams.length;
				
				for ( var x = 0; x < l; x++ )
				{
					t	= streams[ x ];
					
					if ( t.streamId == id )
					{
						s	= t;
						
						break;
					}
				}
				
				return s;
			}
		-->
		</script>
		<script>
			var _gaq=[['_setAccount','X'],['_trackPageview'],['_trackPageLoadTime']];
			(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
			g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
			s.parentNode.insertBefore(g,s)}(document,'script'));
		</script>
	</body>
</html>